<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Run model inference explanation (explain) &mdash; Datumaro Documentation 0.2.2 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Export Datasets" href="export.html" />
    <link rel="prev" title="Download datasets" href="download.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #30638E" >
  <a href="../../../index.html" class="icon"> Datumaro Documentation
</a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design.html">Datumaro Design</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../user-manual.html">User Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../user-manual.html#user-manual">User Manual</a></li>
<li class="toctree-l2"><a class="reference internal" href="../_index.html">User Manual</a></li>
<li class="toctree-l2"><a class="reference internal" href="../extending.html">Extending</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how_to_control_tm_data_collection.html">How to control telemetry data collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how_to_use_datumaro.html">How to use Datumaro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../links.html">Links</a></li>
<li class="toctree-l2"><a class="reference internal" href="../media_formats.html">Media formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../supported_formats.html">Supported Formats</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="command-reference.html">Command Reference</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="command-reference.html#command-reference">Command reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="_index.html">Command reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="checkout.html">Checkout</a></li>
<li class="toctree-l3"><a class="reference internal" href="commit.html">Commit</a></li>
<li class="toctree-l3"><a class="reference internal" href="convert.html">Convert datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="create.html">Create project</a></li>
<li class="toctree-l3"><a class="reference internal" href="detect-format.html">Detect dataset format</a></li>
<li class="toctree-l3"><a class="reference internal" href="diff.html">Compare datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="download.html">Download datasets</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Run model inference explanation (explain)</a></li>
<li class="toctree-l3"><a class="reference internal" href="export.html">Export Datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="filter.html">Filter datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="info.html">Print dataset info</a></li>
<li class="toctree-l3"><a class="reference internal" href="log.html">Log</a></li>
<li class="toctree-l3"><a class="reference internal" href="merge.html">Merge Datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="models.html">Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="patch.html">Patch Datasets</a></li>
<li class="toctree-l3"><a class="reference internal" href="projects.html">Projects</a></li>
<li class="toctree-l3"><a class="reference internal" href="sources.html">Sources</a></li>
<li class="toctree-l3"><a class="reference internal" href="stats.html">Get Project Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="status.html">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="transform.html">Transform Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="util.html">Utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="validate.html">Validate Dataset</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_manual.html">Developer manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../formats/formats.html">Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contribution Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release notes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/cli/cli.html">CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/components/components.html">Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/plugins/plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/util/util/util.html">Utilities</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #30638E" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Datumaro Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../user-manual.html">User Manual</a> &raquo;</li>
          <li><a href="command-reference.html">Command Reference</a> &raquo;</li>
      <li>Run model inference explanation (explain)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/docs/user-manual/command-reference/explain.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="run-model-inference-explanation-explain">
<h1>Run model inference explanation (explain)<a class="headerlink" href="#run-model-inference-explanation-explain" title="Permalink to this headline"></a></h1>
<p>Runs an explainable AI algorithm for a model.</p>
<p>This tool is supposed to help an AI developer to debug a model and a dataset.
Basically, it executes model inference and tries to find relation between
inputs and outputs of the trained model, i.e. determine decision boundaries
and belief intervals for the classifier.</p>
<p>Currently, the only available algorithm is RISE (<a class="reference external" href="https://arxiv.org/pdf/1806.07421.pdf">article</a>),
which runs model a single time and then re-runs a model multiple times on
each image to produce a heatmap of activations for each output of the
first inference. Each time a part of the input image is masked. As a result,
we obtain a number heatmaps, which show, how specific image pixels affected
the inference result. This algorithm doesn’t require any special information
about the model, but it requires the model to return all the outputs and
confidences. The original algorithm supports only classification scenario,
but Datumaro extends it for detection models.</p>
<p>The following use cases available:</p>
<ul class="simple">
<li><p>RISE for classification</p></li>
<li><p>RISE for object detection</p></li>
</ul>
<p>Usage:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>datum explain <span class="o">[</span>-h<span class="o">]</span> -m MODEL <span class="o">[</span>-o SAVE_DIR<span class="o">]</span> <span class="o">[</span>-p PROJECT_DIR<span class="o">]</span>
  <span class="o">[</span>target<span class="o">]</span> <span class="o">{</span>rise<span class="o">}</span> <span class="o">[</span>RISE_ARGS<span class="o">]</span>
</pre></div>
</div>
<p>Parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;target&gt;</span></code> (string) - Target
<a class="reference external" href="/docs/user-manual/how_to_use_datumaro/#revpath">dataset revpath</a>.By default,
uses the whole current project. An image path can be specified instead.
&lt;image path&gt; - a path to the file.
&lt;revpath&gt; - <a class="reference external" href="/docs/user-manual/how_to_use_datumaro/#revpath">a dataset path or a revision path</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;method&gt;</span></code> (string) - The algorithm to use. Currently, only <code class="docutils literal notranslate"><span class="pre">rise</span></code>
is supported.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-m,</span> <span class="pre">--model</span></code> (string) - The model to use for inference</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-o,</span> <span class="pre">--output-dir</span></code> (string) - Directory to save results to
(default: display only)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-p,</span> <span class="pre">--project</span></code> (string) - Directory of the project to operate on
(default: current directory).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-h,</span> <span class="pre">--help</span></code> - Print the help message and exit.</p></li>
<li><p>RISE options:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">-s,</span> <span class="pre">--max-samples</span></code> (number) - Number of algorithm model runs per image
(default: mask size ^ 2).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--mw,</span> <span class="pre">--mask-width</span></code> (number) - Mask width in pixels (default: 7)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--mh,</span> <span class="pre">--mask-height</span></code> (number) - Mask height in pixels (default: 7)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--prob</span></code> (number) - Mask pixel inclusion probability, controls
mask density (default: 0.5)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--iou,</span> <span class="pre">--iou-thresh</span></code> (number) - IoU match threshold for detections
(default: 0.9)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--nms,</span> <span class="pre">--nms-iou-thresh</span></code> (number) - IoU match threshold for detections
for non-maxima suppression (default: no NMS)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--conf,</span> <span class="pre">--det-conf-thresh</span></code> (number) - Confidence threshold for
detections (default: include all)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-b,</span> <span class="pre">--batch-size</span></code> (number) - Batch size for inference (default: 1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--display</span></code> - Visualize results during computations</p></li>
</ul>
</li>
</ul>
<p>Examples:</p>
<ul class="simple">
<li><p>Run RISE on an image, display results:
<code class="docutils literal notranslate"><span class="pre">datum</span> <span class="pre">explain</span> <span class="pre">path/to/image.jpg</span> <span class="pre">-m</span> <span class="pre">mymodel</span> <span class="pre">rise</span> <span class="pre">--max-samples</span> <span class="pre">50</span></code></p></li>
<li><p>Run RISE on a source revision:
<code class="docutils literal notranslate"><span class="pre">datum</span> <span class="pre">explain</span> <span class="pre">HEAD~1:source-1</span> <span class="pre">-m</span> <span class="pre">model</span> <span class="pre">rise</span></code></p></li>
<li><p>Run inference explanation on a single image with online visualization</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>datum create &lt;...&gt;
datum model add mymodel &lt;...&gt;
datum explain -t image.png -m mymodel <span class="se">\</span>
    rise --max-samples <span class="m">1000</span> --display
</pre></div>
</div>
<blockquote>
<div><p>Note: this algorithm requires the model to return
<em>all</em> (or a <em>reasonable</em> amount) the outputs and confidences unfiltered,
i.e. all the <code class="docutils literal notranslate"><span class="pre">Label</span></code> annotations for classification models and
all the <code class="docutils literal notranslate"><span class="pre">Bbox</span></code>es for detection models.
You can find examples of the expected model outputs in <a class="reference external" href="https://github.com/openvinotoolkit/datumaro/tree/develop/tests/test_RISE.py"><code class="docutils literal notranslate"><span class="pre">tests/test_RISE.py</span></code></a></p>
</div></blockquote>
<p>For OpenVINO models the output processing script would look like this:</p>
<p>Classification scenario:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datumaro.components.extractor</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">datumaro.util.annotation_util</span> <span class="kn">import</span> <span class="n">softmax</span>

<span class="k">def</span> <span class="nf">process_outputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="c1"># inputs = model input, array or images, shape = (N, C, H, W)</span>
    <span class="c1"># outputs = model output, logits, shape = (N, n_classes)</span>
    <span class="c1"># results = conversion result, [ [ Annotation, ... ], ... ]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
        <span class="n">input_height</span><span class="p">,</span> <span class="n">input_width</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">confs</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">conf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">confs</span><span class="p">):</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Label</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">conf</span><span class="p">)})</span>

    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
<p>Object Detection scenario:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datumaro.components.extractor</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># return a significant number of output boxes to make multiple runs</span>
<span class="c1"># statistically correct and meaningful</span>
<span class="n">max_det</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="k">def</span> <span class="nf">process_outputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="c1"># inputs = model input, array or images, shape = (N, C, H, W)</span>
    <span class="c1"># outputs = model output, shape = (N, 1, K, 7)</span>
    <span class="c1"># results = conversion result, [ [ Annotation, ... ], ... ]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
        <span class="n">input_height</span><span class="p">,</span> <span class="n">input_width</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">detections</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">image_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">det</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">detections</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">input_width</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">input_height</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">input_width</span> <span class="o">-</span> <span class="n">x</span><span class="p">),</span> <span class="n">input_width</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">input_height</span> <span class="o">-</span> <span class="n">y</span><span class="p">),</span> <span class="n">input_height</span><span class="p">)</span>
            <span class="n">image_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Bbox</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">conf</span><span class="p">}</span> <span class="p">))</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_results</span><span class="p">[:</span><span class="n">max_det</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">results</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="download.html" class="btn btn-neutral float-left" title="Download datasets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="export.html" class="btn btn-neutral float-right" title="Export Datasets" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
  <p>
      &#169; Copyright 2021, Intel.<div>
      <small><a href="https://www.intel.com/content/www/us/en/privacy/intel-privacy-notice.html">Privacy Policy</a></small>
      |
      <small><a href="https://www.intel.com/content/www/us/en/legal/terms-of-use.html">Terms of Use</a></small>
    </div>
    <br/>
    <small>
      Intel technologies may require enabled hardware, software or service activation. // No product or component can be absolutely secure. // Your costs and results may vary. // Performance varies by use, configuration and other factors. // See our complete legal <u><a href="https://edc.intel.com/content/www/us/en/products/performance/benchmarks/overview/?r=219444055">Notices and Disclaimers</a></u>. // Intel is committed to respecting human rights and avoiding complicity in human rights abuses. See Intel’s <a href="https://www.intel.com/content/www/us/en/policy/policy-human-rights.html"><u>Global Human Rights Principles</u></a>. Intel’s products and software are intended only to be used in applications that do not cause or contribute to a violation of an internationally recognized human right.
    </small>
  </p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>